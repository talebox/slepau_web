<script>
	import {
		theme_set,
		theme_get,
		prefers_light,
	} from "@styles/theme/theme.js";
	import { navigate } from "@deps/routing";
	import { db, local_settings$ } from "../store";
	import User from "./User.svelte";
	import { get } from "svelte/store";

	let is_light = theme_get();

	const theme_toggle = () => {
		// console.log("Was ", is_light);
		// Small state machine
		is_light =
			is_light === undefined
				? !prefers_light
				: is_light === !prefers_light
				? prefers_light
				: undefined;
		// console.log("Setting ", is_light);
		theme_set(is_light);
	};

	let open = false;

	let user$ = db.subscribeTo.user();
	let user = get(user$);
	$: {
		user = $user$;
	}

	function toggle_fullscreen() {
		if (!document.fullscreenElement) {
			document.body.requestFullscreen();
		} else {
			document.exitFullscreen();
		}
	}
</script>

<button
	class="toggle icon fixed"
	title="Toggle Drawer"
	on:click={() => (open = !open)}
>
	<svg fill="currentColor" viewBox="0 0 16 16">
		<path
			fill-rule="evenodd"
			d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"
		/>
	</svg>
</button>

{#if open}
	<div class="back" on:click={() => (open = false)} />
	<div class="container fc">
		<div style="font-size:1rem">
			<User />
		</div>

		{#if user?.user !== "public"}
			<button class="menu" on:click={() => navigate("/settings/")}>
				<svg fill="currentColor" viewBox="0 0 16 16" class="icon">
					<path
						d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"
					/>
				</svg>
				Settings</button
			>
			<button class="menu" on:click={db.actions.logout}>
				<svg fill="currentColor" viewBox="0 0 16 16" class="icon">
					<path
						fill-rule="evenodd"
						d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"
					/>
					<path
						fill-rule="evenodd"
						d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"
					/>
				</svg>
				Logout
			</button>
		{:else}
			<button class="menu" on:click={() => navigate("/login")}>
				<svg fill="currentColor" viewBox="0 0 16 16" class="icon">
					<path
						fill-rule="evenodd"
						d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"
					/>
					<path
						fill-rule="evenodd"
						d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"
					/>
				</svg>
				Login
			</button>
		{/if}

		<div style="flex-grow: 1;" />
		<!-- <button class="menu" on:click={() => navigate("/app/notes/")}>
			<svg fill="currentColor" viewBox="0 0 16 16" class="icon">
				<path
					d="M5 10.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"
				/>
				<path
					d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z"
				/>
				<path
					d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z"
				/>
			</svg>
			Notes</button
		> -->
		{#if $local_settings$?.experimental_features}
			<!-- <button
				class="menu experimental"
				on:click={() => navigate("/app/calendar/")}
			>
				Calendar</button
			> -->
			<button
				class="menu experimental"
				on:click={() => navigate("/app/alarms/")}
			>
				Alarms</button
			>
			<button
				class="menu experimental"
				on:click={() => navigate("/app/clock/")}
			>
				Clock</button
			>
		{/if}

		<button class="menu" on:click={() => navigate("/app/well/")}>
			<!-- <span class="icon">üï≥Ô∏è</span>  -->
			<svg fill="currentColor" viewBox="0 0 16 16" class="icon">
				<path
					d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"
				/>
				<path
					d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"
				/>
			</svg>
			Well</button
		>
		<button class="menu" on:click={() => navigate("/app/graph/")}>
			<svg fill="currentColor" viewBox="0 0 16 16" class="icon">
				<path
					fill-rule="evenodd"
					d="M6 3.5A1.5 1.5 0 0 1 7.5 2h1A1.5 1.5 0 0 1 10 3.5v1A1.5 1.5 0 0 1 8.5 6v1H11a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0v-1A.5.5 0 0 1 5 7h2.5V6A1.5 1.5 0 0 1 6 4.5v-1zM8.5 5a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1zM3 11.5A1.5 1.5 0 0 1 4.5 10h1A1.5 1.5 0 0 1 7 11.5v1A1.5 1.5 0 0 1 5.5 14h-1A1.5 1.5 0 0 1 3 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zm4.5.5a1.5 1.5 0 0 1 1.5-1.5h1a1.5 1.5 0 0 1 1.5 1.5v1a1.5 1.5 0 0 1-1.5 1.5h-1A1.5 1.5 0 0 1 9 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1z"
				/>
			</svg>
			Graph</button
		>

		<div style="flex-grow: 1;" />
		
		<div class="fr">
			<button style="flex-grow:1" on:click={() => (open = false)}>Close</button>
			<button on:click={theme_toggle}
				><span style="flex-grow:1">
					{#if is_light === true}
						<svg fill="currentColor" viewBox="0 0 16 16">
							<path
								d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"
							/>
						</svg>
					{:else if is_light === false}
						<svg fill="currentColor" viewBox="0 0 16 16">
							<circle cx="8" cy="8" r="8" />
						</svg>
					{:else}
						<svg fill="currentColor" viewBox="0 0 16 16">
							<path
								d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"
							/>
						</svg>
					{/if}
				</span></button
			>
			<button class="fullscreen" on:click={toggle_fullscreen}>
				<svg fill="currentColor" viewBox="0 0 16 16" class="icon">
					<path
						fill-rule="evenodd"
						d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"
					/>
				</svg>
			</button>
		</div>
	</div>
{/if}

<style>
	.back,
	.container {
		position: fixed;
		top: 0;
		left: 0;
		z-index: 6;
		font-size: 1.3em;

		overscroll-behavior: contain;
	}
	.container > * {
		margin: 0;
	}
	.menu {
		display: flex;
		align-items: center;
	}
	.menu .icon {
		display: inline-block;
		width: 2em;
	}
	.container {
		padding: 10px;
		width: 300px;
		/* height: 100vh;
    height: 100dvh; */
		height: 100%;
		/* padding-bottom: calc(100lvh -); */

		background: var(--background);

		justify-content: center;
		/* align-items: center; */

		gap: 16px;
	}
	.experimental {
		outline: 2px dashed #db28;
	}

	.back {
		width: 100vw;
		height: 100vh;
		background: var(--background-transparent);
		/* z-index: 0; */
	}
	/* To disable blurring on slow mobile devices */
	@media (hover: hover) and (pointer: fine) {
		@supports (backdrop-filter: blur(5px)) {
			.container {
				background: var(--background-transparent);
			}
			.back {
				backdrop-filter: blur(8px);
			}
		}
	}

	.toggle {
		z-index: 5;

		bottom: 0;
		left: 0;
		border-radius: 0;
		border-top-right-radius: 20px;
	}
</style>
